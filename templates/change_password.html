{% extends 'base.html' %}

{% block title %}Change Password{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <div class="mx-auto h-16 w-16 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-key text-2xl text-white"></i>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Change Password</h1>
        <p class="text-gray-600">Update your account security credentials</p>
    </div>

    <!-- Change Password Form -->
    <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
        <form method="POST" class="space-y-6" id="password-form">
            <!-- Current Password -->
            <div>
                <label for="current_password" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-lock mr-2 text-gray-400"></i>Current Password
                </label>
                <div class="relative">
                    <input type="password" 
                           id="current_password" 
                           name="current_password" 
                           required
                           class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white"
                           placeholder="Enter your current password">
                    <button type="button" 
                            onclick="togglePasswordVisibility('current_password')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                        <i class="fas fa-eye" id="current-password-toggle"></i>
                    </button>
                </div>
            </div>

            <!-- New Password -->
            <div>
                <label for="new_password" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-key mr-2 text-gray-400"></i>New Password
                </label>
                <div class="relative">
                    <input type="password" 
                           id="new_password" 
                           name="new_password" 
                           required
                           minlength="6"
                           class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white"
                           placeholder="Enter your new password"
                           oninput="checkPasswordStrength()">
                    <button type="button" 
                            onclick="togglePasswordVisibility('new_password')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                        <i class="fas fa-eye" id="new-password-toggle"></i>
                    </button>
                </div>
                
                <!-- Password Strength Indicator -->
                <div class="mt-2">
                    <div class="flex items-center space-x-2">
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div id="strength-bar" class="h-2 rounded-full transition-all duration-300 bg-gray-300" style="width: 0%"></div>
                        </div>
                        <span id="strength-text" class="text-xs font-medium text-gray-500">Weak</span>
                    </div>
                </div>
            </div>

            <!-- Confirm New Password -->
            <div>
                <label for="confirm_password" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-check-circle mr-2 text-gray-400"></i>Confirm New Password
                </label>
                <div class="relative">
                    <input type="password" 
                           id="confirm_password" 
                           name="confirm_password" 
                           required
                           class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white"
                           placeholder="Confirm your new password"
                           oninput="checkPasswordMatch()">
                    <button type="button" 
                            onclick="togglePasswordVisibility('confirm_password')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                        <i class="fas fa-eye" id="confirm-password-toggle"></i>
                    </button>
                </div>
                <div id="password-match-message" class="mt-1 text-sm"></div>
            </div>

            <!-- Password Requirements -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 class="text-sm font-semibold text-blue-800 mb-2">Password Requirements:</h4>
                <ul class="text-xs text-blue-700 space-y-1">
                    <li class="flex items-center space-x-2">
                        <i class="fas fa-check text-green-500" id="length-check" style="display: none;"></i>
                        <i class="fas fa-times text-red-500" id="length-cross"></i>
                        <span>At least 6 characters long</span>
                    </li>
                    <li class="flex items-center space-x-2">
                        <i class="fas fa-check text-green-500" id="uppercase-check" style="display: none;"></i>
                        <i class="fas fa-times text-red-500" id="uppercase-cross"></i>
                        <span>Contains uppercase letter</span>
                    </li>
                    <li class="flex items-center space-x-2">
                        <i class="fas fa-check text-green-500" id="lowercase-check" style="display: none;"></i>
                        <i class="fas fa-times text-red-500" id="lowercase-cross"></i>
                        <span>Contains lowercase letter</span>
                    </li>
                    <li class="flex items-center space-x-2">
                        <i class="fas fa-check text-green-500" id="number-check" style="display: none;"></i>
                        <i class="fas fa-times text-red-500" id="number-cross"></i>
                        <span>Contains at least one number</span>
                    </li>
                </ul>
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-4 pt-4">
                <button type="submit" 
                        id="submit-btn"
                        disabled
                        class="flex-1 bg-gray-400 text-white py-3 px-4 rounded-lg font-semibold text-lg shadow-lg transition-all duration-200 flex items-center justify-center space-x-2 cursor-not-allowed">
                    <i class="fas fa-save"></i>
                    <span>Update Password</span>
                </button>
                
                <a href="{{ url_for('index') }}" 
                   class="flex-1 bg-gray-600 text-white py-3 px-4 rounded-lg font-semibold text-lg shadow-lg hover:bg-gray-700 transition-all duration-200 flex items-center justify-center space-x-2 text-center">
                    <i class="fas fa-arrow-left"></i>
                    <span>Cancel</span>
                </a>
            </div>
        </form>
    </div>

    <!-- Security Tips -->
    <div class="mt-8 bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-yellow-800 mb-3 flex items-center">
            <i class="fas fa-shield-alt mr-2"></i>Security Tips
        </h3>
        <ul class="text-sm text-yellow-700 space-y-2">
            <li class="flex items-start space-x-2">
                <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
                <span>Use a unique password that you don't use elsewhere</span>
            </li>
            <li class="flex items-start space-x-2">
                <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
                <span>Include a mix of letters, numbers, and special characters</span>
            </li>
            <li class="flex items-start space-x-2">
                <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
                <span>Avoid using personal information like names or dates</span>
            </li>
            <li class="flex items-start space-x-2">
                <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
                <span>Consider using a password manager for better security</span>
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Toggle password visibility
    function togglePasswordVisibility(fieldId) {
        const passwordInput = document.getElementById(fieldId);
        const toggleIcon = document.getElementById(fieldId.replace('_', '-') + '-toggle');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.className = 'fas fa-eye-slash';
        } else {
            passwordInput.type = 'password';
            toggleIcon.className = 'fas fa-eye';
        }
    }
    
    // Check password strength
    function checkPasswordStrength() {
        const password = document.getElementById('new_password').value;
        const strengthBar = document.getElementById('strength-bar');
        const strengthText = document.getElementById('strength-text');
        
        let strength = 0;
        let strengthLabel = 'Weak';
        let strengthColor = 'bg-red-500';
        
        // Length check
        if (password.length >= 6) {
            strength += 25;
            document.getElementById('length-check').style.display = 'inline';
            document.getElementById('length-cross').style.display = 'none';
        } else {
            document.getElementById('length-check').style.display = 'none';
            document.getElementById('length-cross').style.display = 'inline';
        }
        
        // Uppercase check
        if (/[A-Z]/.test(password)) {
            strength += 25;
            document.getElementById('uppercase-check').style.display = 'inline';
            document.getElementById('uppercase-cross').style.display = 'none';
        } else {
            document.getElementById('uppercase-check').style.display = 'none';
            document.getElementById('uppercase-cross').style.display = 'inline';
        }
        
        // Lowercase check
        if (/[a-z]/.test(password)) {
            strength += 25;
            document.getElementById('lowercase-check').style.display = 'inline';
            document.getElementById('lowercase-cross').style.display = 'none';
        } else {
            document.getElementById('lowercase-check').style.display = 'none';
            document.getElementById('lowercase-cross').style.display = 'inline';
        }
        
        // Number check
        if (/\d/.test(password)) {
            strength += 25;
            document.getElementById('number-check').style.display = 'inline';
            document.getElementById('number-cross').style.display = 'none';
        } else {
            document.getElementById('number-check').style.display = 'none';
            document.getElementById('number-cross').style.display = 'inline';
        }
        
        // Determine strength level
        if (strength >= 100) {
            strengthLabel = 'Very Strong';
            strengthColor = 'bg-green-500';
        } else if (strength >= 75) {
            strengthLabel = 'Strong';
            strengthColor = 'bg-blue-500';
        } else if (strength >= 50) {
            strengthLabel = 'Medium';
            strengthColor = 'bg-yellow-500';
        } else if (strength >= 25) {
            strengthLabel = 'Fair';
            strengthColor = 'bg-orange-500';
        }
        
        strengthBar.style.width = strength + '%';
        strengthBar.className = `h-2 rounded-full transition-all duration-300 ${strengthColor}`;
        strengthText.textContent = strengthLabel;
        
        checkPasswordMatch();
        updateSubmitButton();
    }
    
    // Check password match
    function checkPasswordMatch() {
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const messageDiv = document.getElementById('password-match-message');
        
        if (confirmPassword === '') {
            messageDiv.innerHTML = '';
            return;
        }
        
        if (newPassword === confirmPassword) {
            messageDiv.innerHTML = '<i class="fas fa-check text-green-500 mr-1"></i><span class="text-green-600">Passwords match</span>';
        } else {
            messageDiv.innerHTML = '<i class="fas fa-times text-red-500 mr-1"></i><span class="text-red-600">Passwords do not match</span>';
        }
        
        updateSubmitButton();
    }
    
    // Update submit button state
    function updateSubmitButton() {
        const currentPassword = document.getElementById('current_password').value;
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const submitBtn = document.getElementById('submit-btn');
        
        const isValid = currentPassword.length > 0 && 
                       newPassword.length >= 6 && 
                       newPassword === confirmPassword &&
                       /[A-Z]/.test(newPassword) &&
                       /[a-z]/.test(newPassword) &&
                       /\d/.test(newPassword);
        
        if (isValid) {
            submitBtn.disabled = false;
            submitBtn.className = 'flex-1 btn-primary text-white py-3 px-4 rounded-lg font-semibold text-lg shadow-lg transition-all duration-200 flex items-center justify-center space-x-2 cursor-pointer';
        } else {
            submitBtn.disabled = true;
            submitBtn.className = 'flex-1 bg-gray-400 text-white py-3 px-4 rounded-lg font-semibold text-lg shadow-lg transition-all duration-200 flex items-center justify-center space-x-2 cursor-not-allowed';
        }
    }
    
    // Form submission
    document.getElementById('password-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('current_password').value;
        const newPassword = document.getElementById('new_password').value;
        
        if (currentPassword === newPassword) {
            showNotification('New password must be different from current password', 'error');
            return;
        }
        
        // Show loading state
        const submitBtn = document.getElementById('submit-btn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>Updating...</span>';
        submitBtn.disabled = true;
        
        // Submit form
        setTimeout(() => {
            this.submit();
        }, 500);
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('current_password').focus();
        
        // Add event listeners
        document.getElementById('current_password').addEventListener('input', updateSubmitButton);
        document.getElementById('new_password').addEventListener('input', checkPasswordStrength);
        document.getElementById('confirm_password').addEventListener('input', checkPasswordMatch);
    });
</script>
{% endblock %}